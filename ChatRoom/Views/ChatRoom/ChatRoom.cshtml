@inject HttpContextService _httpContextService;

@{
    ViewData["Title"] = "Chat Room";

    // Get user name from claim
    var userName = _httpContextService.GetCurrentUserName();
}

<div class="container py-5" style="max-width: 800px">
    <h2 class="text-center">Chat Room</h2>
    <div class="chat-container">
        <ul id="messagesList"></ul>
    </div>
    <div class="input-group">
        <textarea id="messageInput" class="form-control" rows="3" placeholder="Type your message here..."></textarea>
        <div class="button-container">
            <button id="sendButton" class="btn btn-primary"><i class="fas fa-paper-plane"></i> Send</button>
            <button id="leaveRoomButton" class="btn btn-danger">Leave Room</button>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/3.1.9/signalr.min.js"></script>
    <script>
        var $messagesList = $('#messagesList');

        $(document).ready(function () {
            var hubConnection = new signalR.HubConnectionBuilder().withUrl("/chatRoomHub").build();

            hubConnection.start().then(function () {
                hubConnection.invoke("JoinRoom", "@userName");
                console.log("Connected to chatRoomhub");
            })

            hubConnection.on("JoinRoom", function (message) {
                $messagesList.append($('<li class="message system-message">').html(message));
            });

            hubConnection.on("LeaveRoom", function (message) {
                $messagesList.append($('<li class="message system-message">').html(message));
            });

            hubConnection.on("ReceiveMessage", function (user, message) {
                var messageContent = '<strong>' + user + ':</strong> ' + message;
                $messagesList.append($('<li class="message other-message">').html(messageContent));
            });

            hubConnection.on("ReceiveMessageToCaller", function (message) {
                var messageContent = '<strong>Me:</strong> ' + message;
                $messagesList.append($('<li class="message my-message">').html(messageContent));
            });

            $('#leaveRoomButton').click(function (event) {
                hubConnection.invoke("LeaveRoom", "@userName");
                hubConnection.stop();
                window.location.href = "/ChatRoom/Index";
                event.preventDefault();
            });

            $('#sendButton').click(function (event) {
                sendMessage(hubConnection);
                event.preventDefault();
            });

            $('#messageInput').keypress(function (event) {
                if (event.keyCode === 13) {
                    sendMessage(hubConnection);
                    event.preventDefault();
                }
            });

            function sendMessage(hubConnection) {
                var message = $('#messageInput').val();
                if (message) {
                    hubConnection.invoke("SendMessage", "@userName", message).catch(function (err) {
                        return console.error(err.toString());
                    });
                    $('#messageInput').val('');
                }
            }
        });
    </script>
}
